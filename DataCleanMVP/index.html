<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scheda di sostenibilità ICT – PUE · WUE · CUE · SCI</title>
<style>
  /* ====== PALETTE (bianco + verde acqua) ====== */
  :root{
    --acqua: #20c5bd;       /* primario */
    --acqua-600:#18a7a0;
    --acqua-050:#e9fbfa;    /* superfici leggere */
    --ink:#0f172a;          /* testo principale */
    --muted:#5b6b7a;        /* testo secondario */
    --ok:#21c992;
    --warn:#f59f00;
    --bad:#e03131;
    --elev: 0 1px 2px rgba(16,24,40,.06), 0 8px 24px rgba(16,24,40,.08);
    --ring: rgba(32,197,189,.28);
  }

  *{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
  h1,h2,h3{margin:0 0 6px}
  a{color:var(--acqua-600);text-decoration:none}
  small{color:var(--muted)}

  /* ====== HEADER ====== */
  header{
    padding:16px 16px 14px;
    border-bottom:4px solid var(--acqua);
    background:
      radial-gradient(1000px 180px at 50% -40px, var(--acqua-050), transparent 70%),
      linear-gradient(0deg,#fff,#fff);
  }
  .header-wrap{
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
  }
  .brand img{
    height:180px; width:auto; object-fit:contain;
    image-rendering:auto;
  }
  @media(min-width:720px){
    .brand img{ height:180px; }
  }
  .title{font-weight:800; letter-spacing:.2px; font-size:1.45rem}
  .subtitle{color:var(--muted); font-size:.95rem}

  /* ====== LAYOUT ====== */
  main{max-width:1100px;margin:0 auto;padding:16px}
  .stack{display:flex;flex-direction:column;gap:14px}
  @media(min-width:920px){
    .stack{gap:16px}
  }

  /* ====== CARDS (Material-like) ====== */
  .card{
    background:#fff;border:1px solid #eef2f5;border-radius:16px;padding:14px;
    box-shadow:var(--elev);
  }
  .card h2{font-size:1.06rem}

  /* ====== FORM ====== */
  .grid{display:grid;gap:10px}
  .grid-3{grid-template-columns:1fr}
  @media(min-width:620px){.grid-3{grid-template-columns:repeat(3,1fr)}}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:.84rem;color:var(--muted)}
  input,select{
    border:1px solid #e6ecf1;border-radius:12px;padding:12px 12px;
    font-size:1rem;outline:none;background:#fff;transition:border .15s, box-shadow .15s
  }
  input[type='file']{padding:8px 10px}
  input:focus,select:focus{border-color:var(--acqua); box-shadow:0 0 0 4px var(--ring)}
  .note{color:var(--muted); font-size:.9rem}

  /* ====== BUTTONS ====== */
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .btn{
    position:relative;overflow:hidden;
    background:var(--acqua);color:#fff;border:none;border-radius:12px;
    padding:12px 16px;font-weight:700;cursor:pointer;letter-spacing:.2px;
    box-shadow:0 3px 10px rgba(32,197,189,.22);
    transition:transform .04s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn-outline{
    background:#fff;color:var(--acqua);border:1px solid var(--acqua);
    box-shadow:none;
  }
  .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .6s linear;background:rgba(255,255,255,.6)}
  @keyframes ripple{to{transform:scale(4);opacity:0}}

  /* ====== KPI RESULT ====== */
  .kpi{
    display:grid;gap:10px; grid-template-columns:1fr auto auto; align-items:center;
    border:1px dashed #e9eef3;border-radius:14px;padding:12px 12px;margin:8px 0;background:#fff;
  }
  .chip{
    display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:.86rem
  }
  .chip-ghost{background:var(--acqua-050); color:var(--acqua-600)}
  .badge{color:#fff;min-width:86px;text-align:center}
  .b-ok{background:var(--ok)} .b-warn{background:var(--warn)} .b-bad{background:var(--bad)}
  .muted{color:var(--muted)}
  .divider{height:1px;background:#eef2f5;margin:12px 0}

  details{border:1px solid #e6ecf1;border-radius:12px;padding:10px 12px;background:#fff}
  summary{cursor:pointer;font-weight:700;outline:none}
  details[open]{box-shadow:0 1px 8px rgba(16,24,40,.06)}
  .formula{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .dl{margin:.2rem 0 0 .2rem;padding-left:.6rem}
  .dl dt{font-weight:700}
  .dl dd{margin:.1rem 0 .4rem .6rem;color:var(--muted)}

  .table{width:100%;border-collapse:collapse;font-size:.94rem}
  .table th,.table td{border-bottom:1px solid #eef2f5;padding:8px 6px;text-align:left}
  .table th{color:var(--muted);font-weight:700}

  .alert{
    background:var(--acqua-050); border:1px solid #d7f3f1; color:#0e6b67;
    padding:10px 12px; border-radius:12px; font-size:.92rem;
  }
</style>
</head>
<body>
<header>
  <div class="header-wrap">
    <div class="brand">
      <img src="img/logo-sfondo-bianco-verticale.png" alt="Dataclean logo" />
      <div>
        <div class="title">Scheda di sostenibilità ICT</div>
        <div class="subtitle">Indicatori PUE · WUE · CUE · SCI — emissioni da AWS e soglie personalizzabili</div>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="stack">

    <!-- ====== FORM ====== -->
    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle">Dati misurati</h2>
      <div class="grid grid-3" style="margin-top:6px">
        <div class="field">
          <label for="pue">PUE (minore è meglio) <small>— Valore di sito (non fornito da AWS per account)</small></label>
          <input id="pue" type="number" step="0.01" inputmode="decimal" value="1.45" />
        </div>
        <div class="field">
          <label for="wue">WUE m³/MWh (minore è meglio) <small>— Valore di sito (non fornito da AWS per account)</small></label>
          <input id="wue" type="number" step="0.01" inputmode="decimal" value="0.25" />
        </div>
        <div class="field">
          <label for="cue">CUE kgCO₂e/kWh IT (minore è meglio) <small>— Derivabile da emissioni AWS + kWh IT</small></label>
          <input id="cue" type="number" step="0.0001" inputmode="decimal" value="0.30" />
        </div>
      </div>

      <div class="grid grid-3" style="margin-top:8px">
        <div class="field">
          <label for="sci">SCI gCO₂e per unità funzionale</label>
          <input id="sci" type="number" step="0.01" inputmode="decimal" value="0.00" />
        </div>
        <div class="field">
          <label for="fu">Unità funzionale SCI</label>
          <input id="fu" type="text" value="richiesta API" />
        </div>
        <div class="field">
          <label for="periodo">Periodo di riferimento</label>
          <select id="periodo">
            <option>Mensile</option>
            <option>Trimestrale</option>
            <option>Annuale</option>
            <option>Altro</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <h2>Integrazione dati AWS</h2>
      <div class="grid grid-3" style="margin-top:6px">
        <div class="field">
          <label for="awsCsv">Carica CSV AWS (Customer Carbon Footprint Tool)</label>
          <input id="awsCsv" type="file" accept=".csv,text/csv" />
          <small id="awsSummary" class="note">Nessun file caricato.</small>
        </div>
        <div class="field">
          <label for="itKwh">Energia IT stimata (kWh) <small>per lo stesso periodo del CSV</small></label>
          <input id="itKwh" type="number" step="0.001" inputmode="decimal" value="" placeholder="es. 1250.0" />
        </div>
        <div class="field">
          <label for="embodied">Embodied per UF (kgCO₂e) <small>per SCI</small></label>
          <input id="embodied" type="number" step="0.0001" inputmode="decimal" value="0.0" />
        </div>
      </div>

      <div class="alert" style="margin-top:8px">
        <strong>Nota:</strong> dal CSV AWS ottieni le <em>emissioni</em> (kgCO₂e). Per calcolare <strong>CUE</strong> e l'intensità <strong>I</strong> dell'SCI serve anche l'energia IT (kWh).
        Inserisci qui sopra una stima coerente con il periodo del CSV.
      </div>

      <div class="divider"></div>

      <h2>Soglie (personalizzabili)</h2>
      <div class="grid grid-3" style="margin-top:6px">
        <div class="field">
          <label>Banding PUE → <small>ok ≤ warn &lt; bad</small></label>
          <div class="grid grid-3">
            <input id="pueGood" type="number" step="0.01" value="1.30" title="ok ≤" />
            <input id="pueWarn" type="number" step="0.01" value="1.60" title="warn ≤" />
            <input id="pueBad"  type="number" step="0.01" value="99"   title="bad &gt;" />
          </div>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:6px">
        <div class="field">
          <label>Banding WUE (m³/MWh)</label>
          <div class="grid grid-3">
            <input id="wueGood" type="number" step="0.01" value="0.20" />
            <input id="wueWarn" type="number" step="0.01" value="0.50" />
            <input id="wueBad"  type="number" step="0.01" value="99" />
          </div>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:6px">
        <div class="field">
          <label>Banding CUE (kgCO₂e/kWh IT)</label>
          <div class="grid grid-3">
            <input id="cueGood" type="number" step="0.01" value="0.20" />
            <input id="cueWarn" type="number" step="0.01" value="0.40" />
            <input id="cueBad"  type="number" step="0.01" value="99" />
          </div>
        </div>
      </div>

      <div class="grid grid-3" style="margin-top:8px">
        <div class="field">
          <label>Target SCI (gCO₂e/UF)</label>
          <input id="sciTarget" type="number" step="0.01" value="0.00" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <small>Le soglie non sono normative (servono per benchmark interni).</small>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="valuta">Valuta</button>
        <button class="btn btn-outline" id="stampa">Stampa / PDF</button>
      </div>
    </section>

    <!-- ====== RISULTATI ====== -->
    <section class="card" id="risultati" aria-labelledby="resultTitle">
      <h2 id="resultTitle">Esito &amp; classi</h2>

      <div class="kpi">
        <div>
          <div><strong>PUE</strong> <span class="muted">(minore è meglio)</span></div>
          <div class="muted" id="pueExplain">—</div>
        </div>
        <div id="pueValue" class="chip chip-ghost">—</div>
        <div id="pueBand" class="chip badge">—</div>
      </div>

      <div class="kpi">
        <div>
          <div><strong>WUE</strong> <span class="muted">(m³/MWh, minore è meglio)</span></div>
          <div class="muted" id="wueExplain">—</div>
        </div>
        <div id="wueValue" class="chip chip-ghost">—</div>
        <div id="wueBand" class="chip badge">—</div>
      </div>

      <div class="kpi">
        <div>
          <div><strong>CUE</strong> <span class="muted">(kgCO₂e/kWh IT, minore è meglio)</span></div>
          <div class="muted" id="cueExplain">—</div>
        </div>
        <div id="cueValue" class="chip chip-ghost">—</div>
        <div id="cueBand" class="chip badge">—</div>
      </div>

      <div class="kpi">
        <div>
          <div><strong>SCI</strong> <span class="muted">(gCO₂e per <span id="fuOut">UF</span>)</span></div>
          <div class="muted" id="sciExplain">—</div>
        </div>
        <div id="sciValue" class="chip chip-ghost">—</div>
        <div id="sciBand" class="chip badge">—</div>
      </div>

      <div class="divider"></div>

      <!-- ====== DISCLAIMER ====== -->
      <details>
        <summary>PUE — cos’è e come si calcola</summary>
        <div class="dl">
          <dt>Significato</dt>
          <dd>Power Usage Effectiveness: quanta energia totale del sito è necessaria per 1 unità di energia IT.</dd>
          <dt>Formula</dt>
          <dd class="formula">PUE = Energia totale sito / Energia apparecchiature IT</dd>
          <dt>Note</dt>
          <dd>Indicatore di data center: non è disponibile per account cloud (AWS non lo espone a livello di cliente).</dd>
        </div>
      </details>

      <details>
        <summary>WUE — cos’è e come si calcola</summary>
        <div class="dl">
          <dt>Significato</dt>
          <dd>Water Usage Effectiveness: consumo d’acqua per l’energia IT erogata.</dd>
          <dt>Formula (unità consigliata)</dt>
          <dd class="formula">WUE = Acqua consumata (m³) / Energia IT (MWh)</dd>
          <dt>Note</dt>
          <dd>Indicatore di sito: AWS non fornisce WUE per singolo account/servizio.</dd>
        </div>
      </details>

      <details>
        <summary>CUE — cos’è e come si calcola</summary>
        <div class="dl">
          <dt>Significato</dt>
          <dd>Carbon Usage Effectiveness: emissioni di CO₂e per unità di energia IT.</dd>
          <dt>Formula</dt>
          <dd class="formula">CUE = Emissioni CO₂e totali (kg) / Energia IT (kWh)</dd>
          <dt>Note</dt>
          <dd>Dal CSV AWS ottieni i kgCO₂e; se inserisci i kWh IT, la pagina ricava CUE = kgCO₂e/kWh IT.</dd>
        </div>
      </details>

      <details>
        <summary>SCI — cos’è e come si calcola</summary>
        <div class="dl">
          <dt>Significato</dt>
          <dd>Software Carbon Intensity: emissioni per unità funzionale del software.</dd>
          <dt>Formula (UF=1)</dt>
          <dd class="formula">SCI = E × I + M</dd>
          <dd class="formula" style="margin-top:.2rem"><small>E: energia per UF (kWh), I: intensità (kgCO₂e/kWh), M: embodied per UF (kgCO₂e)</small></dd>
          <dt>Note</dt>
          <dd>Se lavori su più UF insieme: <span class="formula">SCI = (E × I + M) / R</span>, con R = numero di UF.</dd>
        </div>
      </details>

      <div class="divider"></div>

      <h2>Altri indicatori utili (opzionali)</h2>
      <table class="table" aria-label="indicatori opzionali">
        <thead><tr><th>Indicatore</th><th>Descrizione</th></tr></thead>
        <tbody>
          <tr><td><strong>REF</strong> (Renewable Energy Factor)</td><td>Quota rinnovabile sul totale consumato.</td></tr>
          <tr><td><strong>ERF</strong> (Energy Reuse Factor)</td><td>Quota di energia riutilizzata all’esterno.</td></tr>
          <tr><td><strong>CER</strong> (Cooling Efficiency Ratio)</td><td>Calore rimosso per energia dei sistemi di raffreddamento.</td></tr>
          <tr><td><strong>ITEEsv</strong></td><td>Efficienza energetica server (hardware).</td></tr>
        </tbody>
      </table>

      <p class="note">Le norme stabiliscono <em>metodologie</em> e confini di misura, non una scala A–G universale: usa le soglie di progetto sopra per il tuo contesto.</p>
    </section>

  </section>
</main>

<script>
  const $ = (id)=>document.getElementById(id);
  const band = (v,g,w)=> v<=g ? "ok" : (v<=w ? "warn" : "bad");
  const fmt = (n,u="") => (isFinite(n)? `${Number(n).toLocaleString('it-IT', {maximumFractionDigits: 4})}${u}` : "—");

  function update(){
    const pue = parseFloat($("pue").value);
    const wue = parseFloat($("wue").value);
    const cue = parseFloat($("cue").value);
    const sci = parseFloat($("sci").value);
    const fu  = $("fu").value || "unità funzionale";

    const pueG = parseFloat($("pueGood").value);
    const pueW = parseFloat($("pueWarn").value);
    const wueG = parseFloat($("wueGood").value);
    const wueW = parseFloat($("wueWarn").value);
    const cueG = parseFloat($("cueGood").value);
    const cueW = parseFloat($("cueWarn").value);
    const sciT = parseFloat($("sciTarget").value);

    const bP = band(pue,pueG,pueW);
    $("pueValue").textContent = fmt(pue,"");
    $("pueBand").textContent = bP==="ok"?"OK":(bP==="warn"?"ATT.":"CRIT.");
    $("pueBand").className = "chip badge b-"+bP;
    $("pueExplain").textContent = `Soglie: ok ≤ ${pueG} · attenzione ≤ ${pueW}`;

    const bW = band(wue,wueG,wueW);
    $("wueValue").textContent = fmt(wue," m³/MWh");
    $("wueBand").textContent = bW==="ok"?"OK":(bW==="warn"?"ATT.":"CRIT.");
    $("wueBand").className = "chip badge b-"+bW;
    $("wueExplain").textContent = `Soglie: ok ≤ ${wueG} · attenzione ≤ ${wueW}`;

    const bC = band(cue,cueG,cueW);
    $("cueValue").textContent = fmt(cue," kgCO₂e/kWh IT");
    $("cueBand").textContent = bC==="ok"?"OK":(bC==="warn"?"ATT.":"CRIT.");
    $("cueBand").className = "chip badge b-"+bC;
    $("cueExplain").textContent = `Soglie: ok ≤ ${cueG} · attenzione ≤ ${cueW}`;

    $("fuOut").textContent = fu;
    $("sciValue").textContent = fmt(sci,` gCO₂e/${fu}`);
    const sciState = (isFinite(sciT) && sci>0) ? (sci<=sciT?"ok":(sci<=sciT*1.5?"warn":"bad")) : "warn";
    $("sciBand").textContent = sciState==="ok"?"IN TARGET":(sciState==="warn"?"ATT.":"FUORI");
    $("sciBand").className = "chip badge b-"+sciState;
    $("sciExplain").textContent = sciT>0 ? `Target: ≤ ${sciT} gCO₂e/${fu}` : "Imposta un target per valutare l'SCI.";
  }

  // ====== AWS CSV parsing ======
  const state = { awsKgCO2e: null, itKwh: null, intensity: null };

  function parseAwsCsv(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(lines.length < 2) throw new Error("CSV vuoto o senza header.");
    const sep = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
    const headers = lines[0].split(sep).map(h=>h.trim().toLowerCase());

    const emissionIdx = headers.findIndex(h =>
      (h.includes("metric") && h.includes("co2")) ||
      (h.includes("emission") && (h.includes("ton") || h.includes("tco2")))
    );
    if(emissionIdx === -1) throw new Error("Colonna emissioni non trovata (attesa metric tons CO2e).");

    let sumTons = 0;
    for(let i=1;i<lines.length;i++){
      const parts = lines[i].split(sep);
      if(parts.length < headers.length) continue;
      const raw = parts[emissionIdx].replace(",", ".").replace(/"/g,"").trim();
      const v = parseFloat(raw);
      if(Number.isFinite(v)) sumTons += v;
    }
    const kg = sumTons * 1000;
    return kg; // kgCO2e
  }

  function refreshFromAws(){
    const it = parseFloat($("itKwh").value);
    state.itKwh = Number.isFinite(it) ? it : null;

    if(state.awsKgCO2e!=null && state.itKwh!=null && state.itKwh>0){
      state.intensity = state.awsKgCO2e / state.itKwh; // kgCO2e/kWh
      $("cue").value = state.intensity.toFixed(4);
    }
    update();
  }

  $("awsCsv").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const text = reader.result.toString();
        const kg = parseAwsCsv(text);
        state.awsKgCO2e = kg;
        $("awsSummary").textContent = `Emissioni CSV: ${fmt(kg)} kgCO₂e (totale periodo)`;
        refreshFromAws();
      }catch(err){
        $("awsSummary").textContent = "Errore nel parsing: " + err.message;
        state.awsKgCO2e = null;
      }
    };
    reader.readAsText(f);
  });

  ["itKwh"].forEach(id => $(id).addEventListener("input", refreshFromAws));

  ["pue","wue","cue","sci","fu","pueGood","pueWarn","wueGood","wueWarn","cueGood","cueWarn","sciTarget"]
    .forEach(id => $(id).addEventListener("input", update));

  document.querySelectorAll(".btn").forEach(btn=>{
    btn.addEventListener("click", function(e){
      const r = document.createElement("span");
      const d = Math.max(this.clientWidth, this.clientHeight);
      r.style.width = r.style.height = d + "px";
      r.style.left = (e.clientX - this.getBoundingClientRect().left - d/2) + "px";
      r.style.top  = (e.clientY - this.getBoundingClientRect().top  - d/2) + "px";
      r.className = "ripple";
      this.appendChild(r);
      setTimeout(()=>r.remove(), 600);
    });
  });

  update();
</script>
</body>
</html>
